<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal del Ejecutivo</title>
    <style>
        :root {
            --font-main: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            --transition-speed: 0.3s;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1b26; --bg-secondary: #24283b; --bg-tertiary: #414868;
            --text-primary: #c0caf5; --text-secondary: #a9b1d6; --accent: #7dcfff;
            --accent-glow: rgba(125, 207, 255, 0.2); --border-color: #3b3f51;
            --success: #9ece6a; --pending: #e0af68; --danger: #f7768e; --confirmed: #7aa2f7;
            --modal-bg: rgba(36, 40, 59, 0.85);
            --chat-bubble-ejecutiva: #7A4C5D;
            --chat-bubble-planificador: #4E6758;
            --notif-unread-bg: rgba(125, 207, 255, 0.1);
        }
        [data-theme="light"] {
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #495057; --accent: #007bff;
            --accent-glow: rgba(0, 123, 255, 0.15); --border-color: #dee2e6;
            --success: #28a745; --pending: #ffc107; --danger: #dc3545; --confirmed: #007bff;
            --modal-bg: rgba(255, 255, 255, 0.85);
            --chat-bubble-ejecutiva: #F8CECC;
            --chat-bubble-planificador: #D5E8D4;
            --notif-unread-bg: rgba(0, 123, 255, 0.08);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-main); margin: 0; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color var(--transition-speed), color var(--transition-speed); }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background-color: var(--bg-secondary); border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .header-controls h1 { margin: 0; font-size: 1.5rem; color: var(--text-primary); font-weight: 600; }
        .action-buttons { display: flex; align-items: center; gap: 1rem; }
        input, textarea, select, button { width: 100%; padding: 0.6rem 0.75rem; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; margin-bottom: 0; background: var(--bg-tertiary); color: var(--text-primary); }
        [data-theme="dark"] input[type="date"] { color-scheme: dark; }
        label { font-weight: 600; font-size: 0.85rem; margin-bottom: 0.3rem; display: block; color: var(--text-secondary); }
        .form-grid > div { margin-bottom: 0.8rem; }
        #submit-button, #cancel-edit-button { margin-top: 0.8rem !important; }

        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        select:disabled { background-color: var(--bg-primary); opacity: 0.5; cursor: not-allowed; }
        button { font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        button:disabled { background-color: var(--bg-tertiary); cursor: not-allowed; }
        button#submit-button { background-color: var(--accent); color: var(--bg-secondary); }
        button:hover:not(:disabled) { filter: brightness(1.1); }
        .icon-btn {
            background: var(--danger); border-color: var(--danger); color: white;
            padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; gap: 0.5rem; font-weight: 600; width: auto;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 1.5rem; }
        .form-grid .full-width { grid-column: 1 / -1; }

        .currency-input { position: relative; }
        .currency-input::before {
            content: "$"; position: absolute; left: 10px; top: 50%;
            transform: translateY(-50%); color: var(--text-secondary);
            pointer-events: none; font-size: 0.9rem;
        }
        .currency-input input { padding-left: 25px; }

        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.2rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        #login-view { display: flex; align-items: center; justify-content: center; height: 100vh; padding: 1.5rem; }
        .login-card { max-width: 450px; width: 100%; }
        #error-message { color: var(--danger); text-align: center; margin-top: 1rem; display: none; min-height: 1.2em; }
        .secondary-action { background-color: var(--bg-tertiary); color: var(--text-primary); margin-top: 1rem; }
        
        .filter-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.25rem; }
        .filter-controls input[type="search"] { flex: 2; min-width: 200px; }
        .filter-controls select { flex: 1; min-width: 180px; }
        .filter-controls input, .filter-controls select { margin-bottom: 0; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        tbody tr:hover { background-color: var(--bg-tertiary); }
        .status { padding: 0.25rem 0.6rem; border-radius: 12px; font-weight: 600; text-align: center; display: inline-block; font-size: 0.8rem; border: 1px solid currentColor; background: transparent;}
        .status-Pendiente { color: var(--pending); }
        .status-Confirmado, .status-En-Progreso { color: var(--confirmed); }
        .status-Completado { color: var(--success); }

        .action-cell { display: flex; gap: 0.5rem; }
        .action-cell button { padding: 0.4rem 0.8rem; font-size: 0.85rem; width: auto; }
        .btn-detail { background-color: var(--accent); color: var(--bg-secondary); }
        .btn-edit { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-delete { background-color: var(--danger); color: white; }

        .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); transition: var(--transition-speed); border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: var(--transition-speed); border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(24px); }

        .notification-bell { position: relative; }
        #notif-bell-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        #notif-bell-btn:hover { background-color: var(--bg-tertiary); color: var(--accent); }
        #notif-count {
            position: absolute; top: 0; right: 0; background-color: var(--danger); color: white;
            border-radius: 50%; font-size: 0.7rem; font-weight: bold; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center; transform: translate(25%, -25%); display: none;
        }
        #notif-panel {
            position: absolute; top: calc(100% + 10px); right: 0; width: 350px; max-height: 400px;
            overflow-y: auto; background-color: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1100;
            opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all var(--transition-speed);
        }
        #notif-panel.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .notif-item { padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color var(--transition-speed); }
        .notif-item:last-child { border-bottom: none; }
        .notif-item:hover { background-color: var(--bg-tertiary); }
        .notif-item p { margin: 0 0 0.25rem 0; font-size: 0.9rem; line-height: 1.4; }
        .notif-item small { font-size: 0.75rem; color: var(--text-secondary); }
        .notif-item.unread { background-color: var(--notif-unread-bg); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity var(--transition-speed);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-container {
            background: var(--modal-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 16px; width: 95%; max-width: 900px;
            max-height: 90vh; padding: 1.5rem; display: flex; flex-direction: column;
            transform: scale(0.9); transition: transform var(--transition-speed);
        }
        .modal-overlay.visible .modal-container { transform: scale(1); }
        .modal-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h2 { margin: 0; color: var(--accent); }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; padding: 0; }
        .modal-body { display: flex; gap: 1.5rem; overflow: hidden; flex-grow: 1; }
        .modal-details-section { flex: 6; overflow-y: auto; padding-right: 10px; }
        .modal-chat-section { flex: 4; display: flex; flex-direction: column; border-left: 1px solid var(--border-color); padding-left: 1.5rem; overflow: hidden; }
        .modal-chat-section h4 { margin-top: 0; margin-bottom: 1rem; color: var(--text-secondary); text-transform: uppercase; font-size: 1rem; letter-spacing: 1px; }
        .modal-details-section .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; }
        .modal-details-section .detail-item strong { display: block; color: var(--text-secondary); margin-bottom: 0.25rem; font-size: 0.875rem; text-transform: uppercase; }
        .modal-details-section .detail-item span { color: var(--text-primary); font-size: 1rem; word-wrap: break-word; }
        .modal-details-section .full-width { grid-column: 1 / -1; }
        #modal-obs-planificacion { display: block; white-space: pre-wrap; background-color: var(--bg-primary); padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; max-height: 150px; overflow-y: auto; font-style: italic; }
        #modal-chat-history { flex-grow: 1; overflow-y: auto; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-message { max-width: 80%; padding: 0.6rem 0.9rem; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }
        .chat-message.ejecutiva { background-color: var(--chat-bubble-ejecutiva); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-message.planificador { background-color: var(--chat-bubble-planificador); color: var(--text-primary); align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message .sender { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem; opacity: 0.8; }
        #modal-chat-form { display: flex; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        #modal-chat-form input { flex-grow: 1; }
        #modal-chat-form button { width: auto; }

        @media (max-width: 992px) {
            .modal-body { flex-direction: column; }
            .modal-chat-section { border-left: none; border-top: 1px solid var(--border-color); padding-left: 0; padding-top: 1rem; max-height: 40vh; }
        }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="card login-card">
            <h2>Acceso de Ejecutivo</h2>
            <form id="login-form">
                <label for="email">Correo Electrónico</label>
                <input type="email" id="email" required autocomplete="email">
                <label for="password">Contraseña</label>
                <input type="password" id="password" required autocomplete="current-password">
                <button type="submit">Iniciar Sesión</button>
            </form>
            <button id="register-button" class="secondary-action">Registrar Nuevo Ejecutivo</button>
            <p id="error-message"></p>
        </div>
    </div>

    <div id="ejecutivo-view" style="display: none;">
        <div class="container">
            <header class="header-controls">
                <h1 id="welcome-message">Portal del Ejecutivo</h1>
                <div class="action-buttons">
                    <div class="notification-bell">
                        <button id="notif-bell-btn" aria-label="Notificaciones">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        </button>
                        <span id="notif-count"></span>
                        <div id="notif-panel"></div>
                    </div>

                    <button id="logout-button" class="icon-btn">Cerrar Sesión</button>
                    <div class="theme-switch-wrapper">
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </header>

            <div class="card">
                <h2 id="form-title">📝 Generar Nueva Solicitud</h2>
                <form id="form-ejecutivo">
                    <input type="hidden" id="edit-service-id">
                    <div class="form-grid">
                        <div>
                            <label for="numRequerimiento">Nº Requerimiento</label>
                            <input type="text" id="numRequerimiento" placeholder="(Se generará automáticamente)" readonly style="background-color: var(--bg-primary); color: var(--text-secondary); cursor: not-allowed;">
                        </div>
                        <div><label for="numNV">Nº de NV</label><input type="text" id="numNV" required></div>
                        <div class="full-width"><label for="cliente">Nombre del Cliente</label><input type="text" id="cliente" required></div>

                        <div>
                            <label for="montoServicio">Monto del Servicio con IVA:</label>
                            <div class="currency-input">
                                <input type="text" id="montoServicio" name="montoServicio" placeholder="Ej: 15.000" onkeyup="formatCurrency(this)" required>
                            </div>
                        </div>
                        <div>
                            <label for="tipoServicio">Tipo de Servicio:</label>
                            <select id="tipoServicio" name="tipoServicio" required>
                                <option value="">Seleccione un tipo</option>
                            </select>
                        </div>
                        <div>
                            <label for="tieneRepuestos">¿Tiene Repuestos?</label>
                            <select id="tieneRepuestos" required>
                                <option value="No" selected>No</option>
                                <option value="Sí">Sí</option>
                            </select>
                        </div>
                        <div>
                            <label for="repuestosDespachados">¿Repuestos Despachados?</label>
                            <select id="repuestosDespachados" required disabled>
                                <option value="No" selected>No</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Sí">Sí</option>
                            </select>
                        </div>
                        <div class="full-width"><label for="direccion">Dirección</label><input type="text" id="direccion" required></div>
                        <div class="full-width"><label for="fechaProgramacion">Fecha Programación Sugerida</label><input type="date" id="fechaProgramacion" required></div>
                        <div><label for="nomContacto">Nombre Contacto</label><input type="text" id="nomContacto" required></div>
                        <div><label for="numContacto">Teléfono Contacto</label><input type="tel" id="numContacto" required></div>
                        <div class="full-width"><label for="infoServicio">Información del Servicio</label><textarea id="infoServicio" rows="3" required></textarea></div>
                    </div>
                    <button type="submit" id="submit-button">Generar Solicitud</button>
                    <button type="button" id="cancel-edit-button" class="secondary-action" style="display: none;">Cancelar Edición</button>
                </form>
            </div>
            <div class="card">
                <h2>📂 Mis Solicitudes (en tiempo real)</h2>

                <div class="filter-controls">
                    <input type="search" id="search-input" placeholder="Buscar por Nº REQ, Nº NV o Cliente...">
                    <select id="status-filter">
                        <option value="Todos">Todos los Estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Confirmado">Confirmado</option>
                        <option value="En.Progreso">En Progreso</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nº Req.</th>
                                <th>Cliente</th>
                                <th>Monto</th> <th>Tipo Servicio</th> <th>F. Sugerida</th>
                                <th>F. Asignada</th>
                                <th>Últ. Modificación</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-mis-solicitudes"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="service-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modal-req-num"></h2>
                <button class="modal-close-btn" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-details-section">
                     <div class="detail-grid">
                        <div class="detail-item"><strong>Cliente:</strong> <span id="modal-cliente"></span></div>
                        <div class="detail-item"><strong>Nº NV:</strong> <span id="modal-numNV"></span></div>
                        <div class="detail-item full-width"><strong>Dirección:</strong> <span id="modal-direccion"></span></div>
                        <div class="detail-item"><strong>Contacto:</strong> <span id="modal-contacto"></span></div>
                        <div class="detail-item"><strong>Teléfono:</strong> <span id="modal-telefono"></span></div>
                        <div class="detail-item"><strong>Monto Servicio:</strong> <span id="modal-montoServicio"></span></div>
                        <div class="detail-item"><strong>Tipo Servicio:</strong> <span id="modal-tipoServicio"></span></div>
                        <div class="detail-item"><strong>Tiene Repuestos:</strong> <span id="modal-tieneRepuestos"></span></div>
                        <div class="detail-item"><strong>Repuestos Despachados:</strong> <span id="modal-repDespachados"></span></div>
                        <div class="detail-item"><strong>Fecha Sugerida (Ejecutivo):</strong> <span id="modal-fecha-programacion"></span></div>
                        <div class="detail-item"><strong>Fecha Asignada (Planificador):</strong> <span id="modal-fecha-asignada"></span></div>
                        <div class="detail-item"><strong>Estado Actual:</strong> <span id="modal-estado"></span></div>
                        <div class="detail-item"><strong>Fecha Creación:</strong> <span id="modal-fecha-solicitud"></span></div>
                        <div class="detail-item full-width"><strong>Última Edición:</strong> <span id="modal-fecha-edicion"></span></div>
                        <div class="detail-item full-width"><strong>Info. Servicio:</strong> <span id="modal-info-servicio"></span></div>
                        <div class="detail-item full-width">
                            <strong>📝 Observaciones de Planificación:</strong>
                            <span id="modal-obs-planificacion"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-chat-section">
                    <h4>Chat del Servicio</h4>
                    <div id="modal-chat-history"></div>
                    <form id="modal-chat-form">
                        <input type="text" id="modal-chat-input" placeholder="Escribe un mensaje..." required>
                        <button type="submit">Enviar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    // --- SDKs DE FIREBASE v9+ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, getDoc, runTransaction, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // --- CONFIGURACIÓN DE FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAHxnU2r_QdtZTjzC3LL0dYrb9wit6sc0M",
      authDomain: "maquiform-9347f.firebaseapp.com",
      projectId: "maquiform-9347f",
      storageBucket: "maquiform-9347f.firebasestorage.app",
      messagingSenderId: "408016338170",
      appId: "1:408016338170:web:7b10d7413cd8fb69d1dd43"
    };

    // --- INICIALIZACIÓN DE FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let misServiciosCache = [];
    let notificacionesCache = [];
    let unsubscribeListener = null;
    let unsubscribeChat = null;
    let unsubscribeNotificaciones = null;

    const ui = {
        loginView: document.getElementById('login-view'),
        ejecutivoView: document.getElementById('ejecutivo-view'),
        loginForm: document.getElementById('login-form'),
        registerButton: document.getElementById('register-button'),
        emailInput: document.getElementById('email'),
        passwordInput: document.getElementById('password'),
        errorMessage: document.getElementById('error-message'),
        logoutButton: document.getElementById('logout-button'),
        welcomeMessage: document.getElementById('welcome-message'),
        themeToggle: document.getElementById('theme-toggle'),
        notifBellBtn: document.getElementById('notif-bell-btn'),
        notifCount: document.getElementById('notif-count'),
        notifPanel: document.getElementById('notif-panel'),
        formEjecutivo: document.getElementById('form-ejecutivo'),
        formTitle: document.getElementById('form-title'),
        submitButton: document.getElementById('submit-button'),
        cancelButton: document.getElementById('cancel-edit-button'),
        editServiceId: document.getElementById('edit-service-id'),
        numRequerimiento: document.getElementById('numRequerimiento'),
        numNV: document.getElementById('numNV'),
        cliente: document.getElementById('cliente'),
        montoServicio: document.getElementById('montoServicio'),
        tipoServicio: document.getElementById('tipoServicio'),
        tieneRepuestos: document.getElementById('tieneRepuestos'),
        repuestosDespachados: document.getElementById('repuestosDespachados'),
        direccion: document.getElementById('direccion'),
        fechaProgramacion: document.getElementById('fechaProgramacion'),
        nomContacto: document.getElementById('nomContacto'),
        numContacto: document.getElementById('numContacto'),
        infoServicio: document.getElementById('infoServicio'),
        misSolicitudesTbody: document.getElementById('tabla-mis-solicitudes'),
        searchInput: document.getElementById('search-input'),
        statusFilter: document.getElementById('status-filter'),
        modal: {
            overlay: document.getElementById('service-modal'),
            closeBtn: document.getElementById('modal-close'),
            reqNum: document.getElementById('modal-req-num'),
            cliente: document.getElementById('modal-cliente'),
            numNV: document.getElementById('modal-numNV'),
            direccion: document.getElementById('modal-direccion'),
            contacto: document.getElementById('modal-contacto'),
            telefono: document.getElementById('modal-telefono'),
            montoServicio: document.getElementById('modal-montoServicio'),
            tipoServicio: document.getElementById('modal-tipoServicio'),
            tieneRepuestos: document.getElementById('modal-tieneRepuestos'),
            repDespachados: document.getElementById('modal-repDespachados'),
            estado: document.getElementById('modal-estado'),
            fechaSolicitud: document.getElementById('modal-fecha-solicitud'),
            fechaEdicion: document.getElementById('modal-fecha-edicion'),
            infoServicio: document.getElementById('modal-info-servicio'),
            obsPlanificacion: document.getElementById('modal-obs-planificacion'),
            fechaProgramacion: document.getElementById('modal-fecha-programacion'),
            fechaAsignada: document.getElementById('modal-fecha-asignada'),
            chatHistory: document.getElementById('modal-chat-history'),
            chatForm: document.getElementById('modal-chat-form'),
            chatInput: document.getElementById('modal-chat-input'),
        }
    };

    /**
     * Genera un nuevo número de requerimiento correlativo de forma segura.
     * Utiliza una transacción de Firestore para evitar duplicados (race conditions).
     * @returns {Promise<number|null>} El nuevo número de requerimiento o null si falla.
     */
    async function generarNuevoNumeroRequerimiento() {
        const contadorRef = doc(db, 'contadores', 'servicios');
        try {
            const nuevoValor = await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(contadorRef);
                if (!docSnap.exists()) {
                    // Si el documento contador no existe, lo creamos y empezamos en 50001
                    transaction.set(contadorRef, { valorActual: 50001 });
                    return 50001;
                }
                
                const valorAnterior = docSnap.data().valorActual;
                const nuevo = valorAnterior + 1;
                transaction.update(contadorRef, { valorActual: nuevo });
                return nuevo;
            });
            return nuevoValor;
        } catch (e) {
            console.error("Error en la transacción para generar el número:", e);
            alert("Error crítico: No se pudo generar el número de requerimiento. Por favor, inténtelo de nuevo.");
            return null;
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            const userName = user.email.split('@')[0];
            ui.welcomeMessage.textContent = `Bienvenido, ${userName.charAt(0).toUpperCase() + userName.slice(1)}`;
            ui.loginView.style.display = 'none';
            ui.ejecutivoView.style.display = 'block';
            populateTipoServicioDropdowns();
            listenToMisSolicitudes();
            // listenToNotifications(); // Descomentar si se implementa
        } else {
            currentUser = null;
            if (unsubscribeListener) unsubscribeListener();
            if (unsubscribeChat) unsubscribeChat();
            if (unsubscribeNotificaciones) unsubscribeNotificaciones();
            ui.loginView.style.display = 'flex';
            ui.ejecutivoView.style.display = 'none';
            ui.welcomeMessage.textContent = 'Portal del Ejecutivo';
        }
    });

    function populateTipoServicioDropdowns() {
        const tiposDeServicio = [ "Canal Tradicional", "Descanso Turno", "Montaje", "Otro", "Post Venta", "Proyección Asistencia", "Proyección Mantención", "Proyección Repuestos", "Retail Asistencia", "Retail Mantencion", "Retail Repuestos", "Turno", "Vacaciones" ].sort();
        const select = ui.tipoServicio;
        const currentSelection = select.value;
        select.innerHTML = '<option value="">Seleccione un tipo</option>';
        tiposDeServicio.forEach(tipo => {
            select.add(new Option(tipo, tipo));
        });
        select.value = tiposDeServicio.includes(currentSelection) ? currentSelection : '';
    }

    function listenToMisSolicitudes() {
        if (!currentUser) return;
        if (unsubscribeListener) unsubscribeListener();

        const serviciosRef = collection(db, 'servicios');
        const q = query(serviciosRef, where('vendedor', '==', currentUser.email), orderBy('timestamp', 'desc'));
        
        unsubscribeListener = onSnapshot(q, snapshot => {
            misServiciosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        }, error => {
            console.error("Error escuchando datos:", error);
            alert("Error al cargar las solicitudes.");
        });
    }

    function renderTable() {
        const searchTerm = ui.searchInput.value.toLowerCase().trim();
        const statusFilter = ui.statusFilter.value;
        const filteredServices = misServiciosCache.filter(s => {
            const searchMatch = !searchTerm ||
                (s.numRequerimiento && s.numRequerimiento.toLowerCase().includes(searchTerm)) ||
                (s.numNV && s.numNV.toLowerCase().includes(searchTerm)) ||
                (s.cliente && s.cliente.toLowerCase().includes(searchTerm));
            const estadoClass = s.estado ? s.estado.replace(/\s+/g, '.') : '';
            const statusMatch = statusFilter === 'Todos' || estadoClass === statusFilter;
            return searchMatch && statusMatch;
        });

        ui.misSolicitudesTbody.innerHTML = '';
        if (filteredServices.length === 0) {
            const message = misServiciosCache.length > 0 ? "No se encontraron solicitudes con los filtros aplicados." : "Aún no has enviado solicitudes.";
            ui.misSolicitudesTbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">${message}</td></tr>`;
            return;
        }

        filteredServices.forEach(s => {
            const tr = document.createElement('tr');
            const estadoClass = s.estado ? s.estado.replace(/\s+/g, '.') : '';
            const fechaMod = s.fechaEdicion ? `(Ed.) ${formatTimestamp(s.fechaEdicion)}` : formatTimestamp(s.timestamp);
            tr.innerHTML = `
                <td>${s.numRequerimiento || 'N/A'}</td>
                <td>${s.cliente || 'N/A'}</td>
                <td>${displayCurrency(s.montoServicio)}</td> <td>${s.tipoServicio || 'N/A'}</td> <td>${formatDateString(s.fechaProgramacion)}</td>
                <td>${formatDateString(s.fechaAsignada)}</td>
                <td>${fechaMod}</td>
                <td><span class="status status-${estadoClass}">${s.estado || 'N/A'}</span></td>
                <td><div class="action-cell">
                    <button class="btn-detail" data-id="${s.id}">Detalle</button>
                    <button class="btn-edit" data-id="${s.id}">Editar</button>
                    <button class="btn-delete" data-id="${s.id}">Eliminar</button>
                </div></td>`;
            ui.misSolicitudesTbody.appendChild(tr);
        });
    }

    ui.loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        ui.errorMessage.style.display = 'none';
        signInWithEmailAndPassword(auth, ui.emailInput.value, ui.passwordInput.value)
            .catch((error) => { ui.errorMessage.textContent = 'Error: ' + error.message; ui.errorMessage.style.display = 'block'; });
    });

    ui.registerButton.addEventListener('click', () => {
        if (!ui.emailInput.value || !ui.passwordInput.value) {
            ui.errorMessage.textContent = 'Ingresa correo y contraseña para registrar.';
            ui.errorMessage.style.display = 'block'; return;
        }
        createUserWithEmailAndPassword(auth, ui.emailInput.value, ui.passwordInput.value)
            .then(() => { alert('¡Ejecutivo registrado! Ahora inicia sesión.'); ui.loginForm.reset(); })
            .catch((error) => { ui.errorMessage.textContent = 'Error: ' + error.message; ui.errorMessage.style.display = 'block'; });
    });

    ui.logoutButton.addEventListener('click', () => signOut(auth));

    ui.searchInput.addEventListener('input', renderTable);
    ui.statusFilter.addEventListener('change', renderTable);

    ui.misSolicitudesTbody.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button || !button.dataset.id) return;
        const serviceId = button.dataset.id;
        const serviceRef = doc(db, 'servicios', serviceId);
        const action = button.classList;

        if (action.contains('btn-delete')) {
            if (confirm('¿Estás seguro de que deseas eliminar este servicio?')) {
                await deleteDoc(serviceRef).catch(err => alert("Error al eliminar"));
            }
        } else if (action.contains('btn-edit')) {
            const serviceToEdit = misServiciosCache.find(s => s.id === serviceId);
            if (serviceToEdit) populateFormForEdit(serviceToEdit);
        } else if (action.contains('btn-detail')) {
            const service = misServiciosCache.find(s => s.id === serviceId);
            if(service) openModal(service);
        }
    });

    ui.formEjecutivo.addEventListener('submit', async function(e) {
        e.preventDefault();
        ui.submitButton.disabled = true;
        ui.submitButton.textContent = 'Procesando...';

        const serviceId = ui.editServiceId.value;
        let numeroRequerimiento;

        if (serviceId) {
            numeroRequerimiento = ui.numRequerimiento.value;
        } else {
            numeroRequerimiento = await generarNuevoNumeroRequerimiento();
            if (!numeroRequerimiento) {
                ui.submitButton.disabled = false;
                ui.submitButton.textContent = 'Generar Solicitud';
                return; 
            }
        }

        const montoSinFormato = ui.montoServicio.value.replace(/\$|\./g, '');
        const datosServicio = {
            numRequerimiento: String(numeroRequerimiento),
            numNV: ui.numNV.value,
            cliente: ui.cliente.value,
            montoServicio: montoSinFormato,
            tipoServicio: ui.tipoServicio.value,
            tieneRepuestos: ui.tieneRepuestos.value,
            repuestosDespachados: ui.tieneRepuestos.value === 'Sí' ? ui.repuestosDespachados.value : 'N/A',
            direccion: ui.direccion.value,
            fechaProgramacion: ui.fechaProgramacion.value,
            nomContacto: ui.nomContacto.value,
            numContacto: ui.numContacto.value,
            infoServicio: ui.infoServicio.value,
        };

        try {
            if (serviceId) {
                datosServicio.fechaEdicion = serverTimestamp();
                const serviceRef = doc(db, 'servicios', serviceId);
                await updateDoc(serviceRef, datosServicio);
                alert('¡Servicio actualizado con éxito!');
            } else {
                datosServicio.vendedor = currentUser.email;
                datosServicio.estado = 'Pendiente';
                datosServicio.timestamp = serverTimestamp();
                await addDoc(collection(db, 'servicios'), datosServicio);
                alert(`¡Solicitud generada con éxito! Nº de Requerimiento: ${numeroRequerimiento}`);
            }
            resetForm();
        } catch (error) {
            console.error("Error guardando datos:", error);
            alert("Ocurrió un error al guardar la solicitud.");
        } finally {
            ui.submitButton.disabled = false;
            ui.submitButton.textContent = serviceId ? 'Guardar Cambios' : 'Generar Solicitud';
        }
    });

    function populateFormForEdit(service) {
        ui.numRequerimiento.value = service.numRequerimiento || '';
        ui.numNV.value = service.numNV || '';
        ui.cliente.value = service.cliente || '';
        ui.montoServicio.value = displayCurrency(service.montoServicio).replace('$','').trim();
        ui.tipoServicio.value = service.tipoServicio || '';
        ui.tieneRepuestos.value = service.tieneRepuestos || 'No';
        ui.repuestosDespachados.value = service.repuestosDespachados || 'No';
        ui.direccion.value = service.direccion || '';
        ui.fechaProgramacion.value = service.fechaProgramacion || '';
        ui.nomContacto.value = service.nomContacto || '';
        ui.numContacto.value = service.numContacto || '';
        ui.infoServicio.value = service.infoServicio || '';
        ui.editServiceId.value = service.id;
        ui.formTitle.textContent = `✏️ Editando Req #${service.numRequerimiento}`;
        ui.submitButton.textContent = 'Guardar Cambios';
        ui.cancelButton.style.display = 'inline-block';
        handleRepuestosChange();
        ui.formEjecutivo.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetForm() {
        ui.formEjecutivo.reset();
        ui.editServiceId.value = '';
        ui.formTitle.textContent = '📝 Generar Nueva Solicitud';
        ui.submitButton.textContent = 'Generar Solicitud';
        ui.cancelButton.style.display = 'none';
        handleRepuestosChange();
        ui.tipoServicio.value = '';
        ui.tieneRepuestos.value = 'No';
        ui.repuestosDespachados.value = 'No';
        ui.montoServicio.value = '';
        ui.numRequerimiento.value = '';
        ui.numRequerimiento.placeholder = '(Se generará automáticamente)';
    }

    function handleRepuestosChange() {
        const tieneRepuestos = ui.tieneRepuestos.value === 'Sí';
        ui.repuestosDespachados.disabled = !tieneRepuestos;
        if (tieneRepuestos) {
            if (ui.editServiceId.value === '') ui.repuestosDespachados.value = 'Pendiente';
        } else {
            ui.repuestosDespachados.value = 'No';
        }
    }

    ui.cancelButton.addEventListener('click', resetForm);
    ui.tieneRepuestos.addEventListener('change', handleRepuestosChange);

    function openModal(service) {
        ui.modal.reqNum.textContent = `Detalles: Req #${service.numRequerimiento || 'N/A'}`;
        ui.modal.cliente.textContent = service.cliente || 'N/A';
        // ... (resto de la lógica del modal)
        ui.modal.overlay.classList.add('visible');
    }

    function closeModal() {
        ui.modal.overlay.classList.remove('visible');
        if (unsubscribeChat) {
            unsubscribeChat();
            unsubscribeChat = null;
            ui.modal.chatHistory.innerHTML = '';
        }
    }
    ui.modal.closeBtn.addEventListener('click', closeModal);
    ui.modal.overlay.addEventListener('click', (e) => {
        if (e.target === ui.modal.overlay) closeModal();
    });

    // --- Funciones Auxiliares ---
    function formatTimestamp(ts) { if(!ts?.toDate) return 'N/A'; const d=ts.toDate(); return `${d.toLocaleDateString('es-CL')} ${d.toLocaleTimeString('es-CL').slice(0,5)}`; }
    function formatDateString(dateStr) {
        if (!dateStr || dateStr === 'N/A') return 'N/A';
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    window.formatCurrency = function(input) { // Exponer al ámbito global para el onkeyup
        let value = input.value.replace(/[^0-9]/g, '');
        if (value === '') { input.value = ''; return; }
        let numericValue = parseInt(value, 10);
        value = new Intl.NumberFormat('es-CL').format(numericValue);
        input.value = value;
    }
    function displayCurrency(value) {
        if (value === undefined || value === null || value === '') return 'N/A';
        const cleanValue = String(value).replace(/\$|\./g, '');
        const numericValue = parseInt(cleanValue, 10);
        if (isNaN(numericValue)) return 'N/A';
        return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(numericValue);
    }

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        ui.themeToggle.checked = theme === 'dark';
    }
    ui.themeToggle.addEventListener('change', (e) => applyTheme(e.target.checked ? 'dark' : 'light'));
    applyTheme(localStorage.getItem('theme') || 'dark');

</script>
</body>
</html>